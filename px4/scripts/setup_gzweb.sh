#!/bin/bash

apt-get install --yes python
# Get PX4 Models
cd /usr/local/
git clone https://github.com/PX4/PX4-SITL_gazebo-classic.git sitl_gazebo

cd /usr/local/gzweb
source /usr/share/gazebo-11/setup.bash
# export GAZEBO_MODEL_PATH="/usr/local/sitl_gazebo/models:/usr/local/sitl_gazebo/models/realsense_camera:/usr/local/sitl_gazebo/models/realsense_camera/meshes:/usr/local/sitl_gazebo/models/realsense_camera/materials:/usr/local/sitl_gazebo/models/realsense_camera/materials/textures:/usr/local/sitl_gazebo/models/stereo_camera:/usr/local/sitl_gazebo/models/stereo_camera/meshes:/usr/local/sitl_gazebo/models/irlock:/usr/local/sitl_gazebo/models/airspeed:/usr/local/sitl_gazebo/models/iris_depth_camera:/usr/local/sitl_gazebo/models/iris_obs_avoid:/usr/local/sitl_gazebo/models/px4flow:/usr/local/sitl_gazebo/models/delta_wing:/usr/local/sitl_gazebo/models/fpv_cam:/usr/local/sitl_gazebo/models/c920:/usr/local/sitl_gazebo/models/cloudship:/usr/local/sitl_gazebo/models/cloudship/meshes:/usr/local/sitl_gazebo/models/ramp:/usr/local/sitl_gazebo/models/rplidar:/usr/local/sitl_gazebo/models/3DR_gps_mag:/usr/local/sitl_gazebo/models/magnetometer:/usr/local/sitl_gazebo/models/sonar:/usr/local/sitl_gazebo/models/tailsitter:/usr/local/sitl_gazebo/models/tailsitter/meshes:/usr/local/sitl_gazebo/models/iris_opt_flow_mockup:/usr/local/sitl_gazebo/models/standard_vtol:/usr/local/sitl_gazebo/models/standard_vtol/meshes:/usr/local/sitl_gazebo/models/parachute_small:/usr/local/sitl_gazebo/models/parachute_small/meshes:/usr/local/sitl_gazebo/models/matrice_100:/usr/local/sitl_gazebo/models/matrice_100/meshes:/usr/local/sitl_gazebo/models/r1_rover:/usr/local/sitl_gazebo/models/r1_rover/meshes:/usr/local/sitl_gazebo/models/flow_cam:/usr/local/sitl_gazebo/models/plane_catapult:/usr/local/sitl_gazebo/models/shelves_high2:/usr/local/sitl_gazebo/models/shelves_high2/meshes:/usr/local/sitl_gazebo/models/shelves_high2/materials:/usr/local/sitl_gazebo/models/shelves_high2/materials/textures:/usr/local/sitl_gazebo/models/iris_rplidar:/usr/local/sitl_gazebo/models/big_box:/usr/local/sitl_gazebo/models/big_box/meshes:/usr/local/sitl_gazebo/models/big_box/materials:/usr/local/sitl_gazebo/models/big_box/materials/textures:/usr/local/sitl_gazebo/models/uneven_ground:/usr/local/sitl_gazebo/models/uneven_ground/materials:/usr/local/sitl_gazebo/models/uneven_ground/materials/textures:/usr/local/sitl_gazebo/models/uuv_hippocampus:/usr/local/sitl_gazebo/models/uuv_hippocampus/meshes:/usr/local/sitl_gazebo/models/parachute_package:/usr/local/sitl_gazebo/models/standard_vtol_hitl:/usr/local/sitl_gazebo/models/tiltrotor:/usr/local/sitl_gazebo/models/tiltrotor/meshes:/usr/local/sitl_gazebo/models/foggy_lidar:/usr/local/sitl_gazebo/models/bumper_sensor:/usr/local/sitl_gazebo/models/iris:/usr/local/sitl_gazebo/models/iris/meshes:/usr/local/sitl_gazebo/models/shelves_high:/usr/local/sitl_gazebo/models/shelves_high/meshes:/usr/local/sitl_gazebo/models/shelves_high/materials:/usr/local/sitl_gazebo/models/shelves_high/materials/scripts:/usr/local/sitl_gazebo/models/shelves_high/materials/textures:/usr/local/sitl_gazebo/models/iris_fpv_cam:/usr/local/sitl_gazebo/models/lidar:/usr/local/sitl_gazebo/models/small_box:/usr/local/sitl_gazebo/models/small_box/meshes:/usr/local/sitl_gazebo/models/small_box/materials:/usr/local/sitl_gazebo/models/small_box/materials/textures:/usr/local/sitl_gazebo/models/big_box3:/usr/local/sitl_gazebo/models/big_box3/meshes:/usr/local/sitl_gazebo/models/big_box3/materials:/usr/local/sitl_gazebo/models/big_box3/materials/textures:/usr/local/sitl_gazebo/models/iris_downward_depth_camera:/usr/local/sitl_gazebo/models/standard_vtol_drop:/usr/local/sitl_gazebo/models/geotagged_cam:/usr/local/sitl_gazebo/models/big_box4:/usr/local/sitl_gazebo/models/big_box4/meshes:/usr/local/sitl_gazebo/models/big_box4/materials:/usr/local/sitl_gazebo/models/big_box4/materials/textures:/usr/local/sitl_gazebo/models/europallet:/usr/local/sitl_gazebo/models/europallet/meshes:/usr/local/sitl_gazebo/models/europallet/materials:/usr/local/sitl_gazebo/models/europallet/materials/textures:/usr/local/sitl_gazebo/models/depth_camera:/usr/local/sitl_gazebo/models/depth_camera/meshes:/usr/local/sitl_gazebo/models/Box:/usr/local/sitl_gazebo/models/pixhawk:/usr/local/sitl_gazebo/models/iris_stereo_camera:/usr/local/sitl_gazebo/models/r200:/usr/local/sitl_gazebo/models/ocean:/usr/local/sitl_gazebo/models/ocean/media:/usr/local/sitl_gazebo/models/ocean/media/materials:/usr/local/sitl_gazebo/models/ocean/media/materials/scripts:/usr/local/sitl_gazebo/models/ocean/media/materials/textures:/usr/local/sitl_gazebo/models/ocean/media/materials/programs:/usr/local/sitl_gazebo/models/ocean/media/models:/usr/local/sitl_gazebo/models/vtol_downward_depth_camera:/usr/local/sitl_gazebo/models/mb1240-xl-ez4:/usr/local/sitl_gazebo/models/omnicopter:/usr/local/sitl_gazebo/models/omnicopter/meshes:/usr/local/sitl_gazebo/models/iris_foggy_lidar:/usr/local/sitl_gazebo/models/sf10a:/usr/local/sitl_gazebo/models/boat:/usr/local/sitl_gazebo/models/boat/meshes:/usr/local/sitl_gazebo/models/asphalt_plane:/usr/local/sitl_gazebo/models/asphalt_plane/materials:/usr/local/sitl_gazebo/models/asphalt_plane/materials/scripts:/usr/local/sitl_gazebo/models/asphalt_plane/materials/textures:/usr/local/sitl_gazebo/models/big_box2:/usr/local/sitl_gazebo/models/big_box2/meshes:/usr/local/sitl_gazebo/models/big_box2/materials:/usr/local/sitl_gazebo/models/big_box2/materials/textures:/usr/local/sitl_gazebo/models/matrice_100_opt_flow:/usr/local/sitl_gazebo/models/techpod:/usr/local/sitl_gazebo/models/techpod/meshes:/usr/local/sitl_gazebo/models/iris_rtps:/usr/local/sitl_gazebo/models/iris_hitl:/usr/local/sitl_gazebo/models/iris_opt_flow:/usr/local/sitl_gazebo/models/plane_cam:/usr/local/sitl_gazebo/models/BoxesLargeOnPallet_3:/usr/local/sitl_gazebo/models/px4vision:/usr/local/sitl_gazebo/models/px4vision/meshes:/usr/local/sitl_gazebo/models/pallet_full:/usr/local/sitl_gazebo/models/shelves_high2_no_collision:/usr/local/sitl_gazebo/models/shelves_high2_no_collision/meshes:/usr/local/sitl_gazebo/models/shelves_high2_no_collision/materials:/usr/local/sitl_gazebo/models/shelves_high2_no_collision/materials/textures:/usr/local/sitl_gazebo/models/sun:/usr/local/sitl_gazebo/models/gps:/usr/local/sitl_gazebo/models/imu:/usr/local/sitl_gazebo/models/believer:/usr/local/sitl_gazebo/models/believer/meshes:/usr/local/sitl_gazebo/models/iris_triple_depth_camera:/usr/local/sitl_gazebo/models/iris_dual_gps:/usr/local/sitl_gazebo/models/BoxesLargeOnPallet_2:/usr/local/sitl_gazebo/models/ground_plane:/usr/local/sitl_gazebo/models/typhoon_h480:/usr/local/sitl_gazebo/models/typhoon_h480/meshes:/usr/local/sitl_gazebo/models/advanced_plane:/usr/local/sitl_gazebo/models/plane_lidar:/usr/local/sitl_gazebo/models/glider:/usr/local/sitl_gazebo/models/rover:/usr/local/sitl_gazebo/models/rover/meshes:/usr/local/sitl_gazebo/models/rover/materials:/usr/local/sitl_gazebo/models/rover/materials/scripts:/usr/local/sitl_gazebo/models/rover/materials/textures:/usr/local/sitl_gazebo/models/BoxesLargeOnPallet:/usr/local/sitl_gazebo/models/BoxesLargeOnPallet/materials:/usr/local/sitl_gazebo/models/BoxesLargeOnPallet/materials/scripts:/usr/local/sitl_gazebo/models/polaris_ranger_ev:/usr/local/sitl_gazebo/models/polaris_ranger_ev/meshes:/usr/local/sitl_gazebo/models/polaris_ranger_ev/materials:/usr/local/sitl_gazebo/models/polaris_ranger_ev/materials/scripts:/usr/local/sitl_gazebo/models/polaris_ranger_ev/materials/textures:/usr/local/sitl_gazebo/models/plane:/usr/local/sitl_gazebo/models/plane/meshes:/usr/local/sitl_gazebo/models/iris_vision:/usr/local/sitl_gazebo/models/iris_irlock:/usr/local/sitl_gazebo/models/uuv_bluerov2_heavy:/usr/local/sitl_gazebo/models/uuv_bluerov2_heavy/meshes:${GAZEBO_MODEL_PATH}"
export GAZEBO_MODEL_PATH="/usr/local/sitl_gazebo/models:${GAZEBO_MODEL_PATH}"


# ARM CPU workaround: This change makes it so you can run gzweb and it's npm scripts on ARM-based systems.
# Without this change gzweb (and the other npm scripts) just crash.
#
# We fix the problem by reverting to an older version of the "websocket" library.
# If you're running on an ARM CPU, we need to use an older version of the
# "websocket" library because the newer versions depend on a native library that
# isn't built for Linux on ARM. Thankfully the older version is a pure JS
# library. Unfortunately, the old version might be a little slower but it's
# better than nothing. 
dpkgArch="$(dpkg --print-architecture)"
if [ "$dpkgArch" = "arm64" ]; then
    sed -i 's/"websocket": "\^1\.0\.25"/"websocket": "1.0.25"/g' package.json
fi

npm run deploy --- -m local -c -t
# npm run deploy --- -m -c -t

